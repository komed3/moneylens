/** Global data, loaded from JSON */
let data = {};

/** Debounce input calculation trigger */
let debounceTimeout = null;

/** Utility to format number with tseps */
function formatNumber ( num, max = 0, min = 0 ) {

    return Number ( num ).toLocaleString( 'en-US', {
        minimumFractionDigits: min,
        maximumFractionDigits: max
    } );

}

/** Animate a value from its last to the new given value */
function animateValue ( key, newValue, decimals = 0, duration = 600 ) {

    const el = document.querySelector( `[data-item="${key}"]` );

    if ( el ) {

        const startValue = parseFloat( el.dataset.value ) || 0;
        const startTime = performance.now();
        const diff = newValue - startValue;

        function update ( currentTime ) {

            const elapsed = currentTime - startTime;
            const progress = Math.min( elapsed / duration, 1 );
            const value = startValue + diff * progress;

            el.textContent = formatNumber( value, decimals, decimals );
            el.dataset.value = value;

            if ( progress < 1 ) {

                requestAnimationFrame( update );

            } else {

                el.dataset.value = newValue;
                el.textContent = formatNumber( newValue, decimals, decimals );

            }

        };

        requestAnimationFrame( update );

    }

}

/** Initialize displayed data values from JSON */
function insertDataValues ( dataObj ) {

    document.querySelectorAll( '[data-info]' ).forEach( el => {

        const key = el.getAttribute( 'data-info' );

        if ( key in dataObj ) el.textContent = formatNumber( dataObj[ key ], 2, 0 );

    } );

}

/** Sanitize and format input */
function handleInput ( e ) {

    const inputField = e.target;

    // Remove all non-digit characters
    let rawValue = inputField.value.replace( /[^\d]/g, '' );

    // Avoid leading zeros
    rawValue = rawValue.replace( /^0+/, '' );

    // If empty, set to "0"
    if ( ! rawValue ) rawValue = 0;

    // Format number with thousand separators
    const formatted = formatNumber( rawValue );
    inputField.value = formatted;

    calculate_metrics( rawValue );

}

/** Calculate metrics */
function calculate_metrics ( val ) {

    clearTimeout( debounceTimeout );

    debounceTimeout = setTimeout( () => {

        calc_metric__gold( val );
        calc_metric__coins( val );
        calc_metric__diamond( val );
        calc_metric__savings( val );
        calc_metric__interest( val );
        calc_metric__expenses( val );
        calc_metric__burger( val );
        calc_metric__gwr( val );
        calc_metric__hardware( val );
        calc_metric__oil( val );
        calc_metric__btc( val );
        calc_metric__work( val );
        calc_metric__global( val );
        calc_metric__giving( val );
        calc_metric__bin( val );

    }, 300 );

}

/** Calculate gold weight and sphere diameter */
function calc_metric__gold ( val ) {

    const weight = val / data.gold_price;
    const volume = weight / 19.32;
    const diameter = 2 * Math.cbrt( ( 3 * volume ) / ( 4 * Math.PI ) );

    animateValue( '__gold_weight', weight, 3 );
    animateValue( '__gold_diameter', diameter, 3 );

}

/** Calculate number of US dollar coins and resulting physical dimensions */
function calc_metric__coins ( val ) {

    const weight = val * data.coin_weight / 1000000;
    const height = val * data.coin_height / 100000;
    const fields = val / ( 91440 * 48800 / Math.pow( data.coin_diameter, 2 ) );

    animateValue( '__coins_weight', weight, 3 );
    animateValue( '__coins_height', height, 3 );
    animateValue( '__coins_fields', fields, 3 );

}

/** Calculate the Diamond carat equivalent */
function calc_metric__diamond ( val ) {

    const carat = val / data.diamond_carat;

    animateValue( '__diamond_carat', carat, 3 );

}

/** Calculate the avg. US household savings and income equivalent */
function calc_metric__savings ( val ) {

    const savings = val / data.savings;
    const income = val / ( data.income / 12 );

    animateValue( '__household_savings', savings, 3 );
    animateValue( '__household_income', income, 3 );

}

/** Calculate the money generated by investing at a fixed interest rate since year 0 */
function calc_metric__interest ( val ) {

    const cash = val * Math.pow(
        1 + ( data.interest / 100 ),
        new Date().getFullYear()
    );

    const gold = cash / ( data.gold_price * 1e6 );

    animateValue( '__interest_cash', cash / 1e12, 0 );
    animateValue( '__interest_gold', gold / 1e9, 0 );

}

/** Calculate living expenses in some countries */
function calc_metric__expenses ( val ) {

    const us = val / data.expenses_us;
    const de = val / data.expenses_de;
    const ch = val / data.expenses_ch;
    const india = val / data.expenses_in;
    const pk = val / data.expenses_pk;

    animateValue( '__expenses_us', us, 0 );
    animateValue( '__expenses_de', de, 0 );
    animateValue( '__expenses_ch', ch, 0 );
    animateValue( '__expenses_in', india, 0 );
    animateValue( '__expenses_pk', pk, 0 );

}

/** Calculate the number of burger */
function calc_metric__burger ( val ) {

    const burger = val / data.burger;

    animateValue( '__burger_amount', burger, 0 );

}

/** Calculate the global weath rank (top % of world population) */
function calc_metric__gwr ( val ) {

    const pct = Math.max( 0, Math.min( 100, 100 - 100 / (
        1 + Math.pow( Math.E, -1.3 * ( Math.log( val ) - 10 ) )
    ) ) );

    const rank = data.population / 100 * pct;

    animateValue( '__gwr_pct', pct, 2 );
    animateValue( '__gwr_rank', rank, 0 );

}

/** Calculate hardware and electronic equivalents */
function calc_metric__hardware ( val ) {

    const gpu = val / data.gpu;
    const iphone = val / data.iphone;
    const console = val / data.console;

    animateValue( '__hardware_gpu', gpu, 0 );
    animateValue( '__hardware_iphone', iphone, 0 );
    animateValue( '__hardware_console', console, 0 );

}

/** Calculate barrels of crude oil */
function calc_metric__oil ( val ) {

    const barrel = val / data.crude_oil;

    animateValue( '__oil_barrel', barrel, 3 );

}

/** Calculate the amount of Bitcoin */
function calc_metric__btc ( val ) {

    const btc = val / data.btc;

    animateValue( '__btc_amount', btc, 3 );

}

/** Calculate the amount of working hours (federal minimum wage) */
function calc_metric__work ( val ) {

    const hrs = val / data.fed_wage;
    const months = hrs / 160;

    animateValue( '__work_hrs', hrs, 0 );
    animateValue( '__work_months', months, 0 );

}

/** Calculate the percentage of global wealth */
function calc_metric__global ( val ) {

    const pct = val * 100 / data.global_wealth;

    animateValue( '__global_wealth', pct, 10 );

}

/** Calculate some non-profit equivalents */
function calc_metric__giving ( val ) {

    const trees = val / data.tree;
    const forest = val / data.forest_sqft;

    animateValue( '__giving_tree', trees, 0 );
    animateValue( '__giving_forest', forest, 0 );

}

/** Calculate the percentage of the money bin */
function calc_metric__bin ( val ) {

    const pct = val * 100 / data.money_bin;

    animateValue( '__money_bin', pct, 8 );

}

/** Add event listener on DOM load */
document.addEventListener( 'DOMContentLoaded', () => {

    fetch( './data.json' )
        .then( res => res.json() )
        .then( ( json ) => {
            data = json;
            insertDataValues( data );
        } )
        .catch( ( err ) => {
            console.error( 'Error loading JSON:', err )
        } );

    const input = document.getElementById( 'input' );

    if ( input ) input.addEventListener( 'input', handleInput );

} );
